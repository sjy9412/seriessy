{% extends 'base.html' %}
{% load static %}
{% load order_by %}
{% block head %}
<link rel="stylesheet" type="text/css" href="http://kenwheeler.github.io/slick/slick/slick.css" />
<link rel="stylesheet" type="text/css" href="http://kenwheeler.github.io/slick/slick/slick-theme.css" />
<script src="http://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g=" crossorigin="anonymous"></script>
<script type="text/javascript" src="http://kenwheeler.github.io/slick/slick/slick.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/swiper/css/swiper.css">
<link rel="stylesheet" href="https://unpkg.com/swiper/css/swiper.min.css">
<script src="https://unpkg.com/swiper/js/swiper.js"></script>
<script src="https://unpkg.com/swiper/js/swiper.min.js"></script>
{% endblock %}
{% block css %}
.swiper-container {
      overflow: hidden;
      width: 100%;
      padding-top: 50px;
      padding-bottom: 50px;
    }
    .swiper-slide {
      background-position: center;
      background-size: cover;
      width: 300px;
      height: 300px;
    }
 .movies:link { 
   color: black; 
   text-decoration: none;
   }
 .movies:visited {
    color: black; 
    text-decoration: none;
    }
 .movies:hover { 
   color: rgb(60, 116, 108); 
   text-decoration: none;
   }
.background-change-wrap {
  text-align: center;
  height: 300vh;
}
.background-change-wrap > div {
  overflow: hidden;
  width: 100%;
  position: sticky;
  top: 0;
  left: 0;
  height: 100vh;
}
.background-change-wrap > div > img {
  position: sticky;
  width: 100%;
  object-fit: cover;
}
h1 {
  overflow: hidden;
  text-align: center;
  position: sticky;
}
{% endblock %}
{% block body %}
{% for s in series %}
<section class="background-change-wrap">
<div>
<img src="https://image.tmdb.org/t/p/w500/{{ s.backdrop_path }}" alt="{{ s.name }} backdrop path" height="100%">
</div>
<div class="m-5" style="hight:300vh; width:95%" id="{{ s.pk }}">
<br>
<br>
<br>
<br>
<br>
<h1>
{{ s.name }}
{% if user.is_authenticated %}
{% if user in s.like_users.all %}
    <button class="btn btn-primary" id='like-button' data-id="{{ s.pk }}">옆구리에 빼기</button>
    {% else %}
    <button class="btn btn-primary" id='like-button' data-id="{{ s.pk }}">옆구리에 추가</button>
    {% endif %}
<button class="btn btn-primary" data-toggle="modal" data-target="#series-{{ s.pk }}">옆구리에 추가한 사람들</button>
{% endif %}
</h1>
<div class="swiper-container" > 
    <div class="swiper-wrapper">
      {% for movie in s.movie_set.all|order_by:"release_date" %}
      <div class="swiper-slide" style="border-radius: 1%; width:30vw; height:62vh; background-color:#ffffff">
      <a class="movies" href="{% url 'series:movie_detail' movie.pk %}">
      {% if movie.poster_path %}
      <img src="https://image.tmdb.org/t/p/w500/{{ movie.poster_path }}" class="m-2" style="border-radius: 1%; width:28vw; height:52vh;" alt="">
      {% else %}
      <img src="https://image.tmdb.org/t/p/w500/{{ s.poster_path }}" class="m-2" style="border-radius: 1%; width:28vw; height:52vh;" alt="">
      {% endif %}
      </a>
      <h3 class="m-3">{{ movie.title }}</h3>
      </div>
      {% endfor %}
    </div>
    <!-- Add Pagination -->
    <div class="swiper-pagination"></div>
  </div>
</div>
<!-- Slider main container -->
</section>
<div class="modal" tabindex="-1" role="dialog" id="series-{{ s.pk }}">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ s.name }} 추가한 사람들 [<span id="cnt"></span>명]</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div id='list' class="modal-body">
        {% for u in s.like_users.all %}
        {% if u == user %}
        <p id='user'>{{ u }}</p>
        {% endif %}
        {% endfor %}
        {% for u in s.like_users.all %}
        {% if u in user.followings.all %}
        <p><a href="{% url 'accounts:detail' u.pk %}">{{ u }}</a>
        <button class="btn btn-sm btn-primary" id="follow-button" data-id="{{u.pk}}">팔로우 취소</button>
        </p> 
        {% endif %}
        {% endfor %}
        {% for u in s.like_users.all %}
        {% if u not in user.followings.all and u != user %}
        <p>{{ u }}
        <button class="btn btn-sm btn-primary" id="follow-button" data-id="{{u.pk}}">팔로우</button>
        </p>
        {% endif %}
        {% endfor %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<script>
let ticking = false;

function isElementUnderBottom(elem, triggerDiff) {
  const { top } = elem.getBoundingClientRect();
  const { innerHeight } = window;
  return top > innerHeight + (triggerDiff || 0);
}

function handleScroll() {
  ticking = false;
  
  const changeBgSection = document.querySelectorAll('.background-change-wrap');
  changeBgSection.forEach(elem => {
  const changeBgImg = elem.querySelector('div');
  const {top: bgTop, height: bgHeight} = elem.getBoundingClientRect();
  if (bgTop <= 0) {
    const rate = (-1) * bgTop / 5;
    changeBgImg.style.filter = `grayscale(${rate}%)`;
    changeBgImg.style.opacity = `${(100-rate/5) / 100}`;
    console.log(changeBgImg.style.opacity)
  } else {
    changeBgImg.style.filter = 'none';
    changeBgImg.style.opacity = `1`;
  }
  })
}

function requestTick() {
  if(!ticking) {
    requestAnimationFrame(handleScroll);
  }
  ticking = true;
}

 window.addEventListener('scroll', requestTick);

const likeButton = document.querySelectorAll('#like-button')
  likeButton.forEach(elem => {
  elem.addEventListener('click', function(event){
      console.log(event.target.dataset.id)
      axios.defaults.xsrfCookieName = 'csrftoken'
      axios.defaults.xsrfHeaderName = 'X-CSRFToken'
      axios.defaults.headers.common['X-REQUESTED-WITH'] = 'XMLHttpRequest'
      axios.post(`/series/${event.target.dataset.id}/like/`)
        .then(response => {
          // const cnt = document.querySelector('#cnt')
          // cnt.innerText = `${response.data.count}`
          if (response.data.is_liked == 'max') {
            alert("5개 이상 추가할 수 없습니다!")
          }
          else if (response.data.is_liked) {
            $('#user').remove()
          event.target.innerText = '옆구리에 추가'
          }
          else {
            console.log(response.data.user)
            const list = document.querySelector('#list')
            const user = document.createElement('p')
            user.id = 'user'
            user.innerText = `${response.data.user}`
            list.prepend(user)
            event.target.innerText = '옆구리에 빼기'
          }
        })
      .catch(error => {
        console.log(error)
      })
    })
    })

  const followButton = document.querySelectorAll('#follow-button')
  followButton.forEach(elem => {
  elem.addEventListener('click', function(event){
      console.log(event.target.dataset.id)
      axios.defaults.xsrfCookieName = 'csrftoken'
      axios.defaults.xsrfHeaderName = 'X-CSRFToken'
      axios.defaults.headers.common['X-REQUESTED-WITH'] = 'XMLHttpRequest'
      axios.post(`/accounts/${event.target.dataset.id}/detail/following/`)
        .then(response => {
          if (response.data.is_follow) {
          event.target.innerText = '팔로우'
          }
          else {
            event.target.innerText = '팔로우 취소'
          }
        })
      .catch(error => {
        console.log(error)
      })
    })
    })


</script>
<script>
    var swiper = new Swiper('.swiper-container', {
      effect: 'coverflow',
      grabCursor: true,
      centeredSlides: true,
      slidesPerView: 'auto',
      coverflowEffect: {
        rotate: 30,
        stretch: 0,
        depth: 100,
        modifier: 1,
        slideShadows : true,
      },
      pagination: {
        el: '.swiper-pagination',
      },
    });
  </script>
{% endblock %}
